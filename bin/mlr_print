#!/usr/bin/zsh

set -A opt_printer "-p" "11"

zparseopts -K -D -- p:=opt_printer h=opt_help
if [[ $? != 0 || "$opt_help" != "" || "$*" == "" ]]
then
  echo Usage: $(basename "$0") "[-p PRINTER] FILES"
  return -1
fi

case $opt_printer[2] in
  11)
    echo Printer: 11.
    printer="-P php11"
    ;;
  kop)
    echo Printer: KOP.
    printer="-P kop21"
    ;;
  bw)
    echo Printer: B/W.
    printer="-P php18"
    ;;
  c)
    echo Printer: Color.
    printer="-P php19c"
    ;;
  carola)
    echo Printer: Carola\'s.
    printer="-P pbvise"
    ;;
  *)
    echo "Error: Selected printer '$opt_printer[2]' does not exist."
    echo "       Select one of: bw, c, carola."
    return -2
    ;;
esac

echo Files to print: "$#*"
let "e = 0"

# creating blank page
blank="/tmp/blank.pdf"
echo "" | ps2pdf -sPAPERSIZE=a4 - $blank

# selecting PDF files
pdffiles=()
for i in $*
do
  # if [[ -f $i ]]
  if [[ $(file $i | grep -q "PDF") -eq 0 ]]
  then
    pdffiles+=($i)
    # adding blank page if odd number of pages
    npages=$(pdftk $i dump_data | grep NumberOfPages | sed 's/[^0-9]*//')
    [ $(($npages % 2)) -ne 0 ] && pdffiles+=($blank)
  else
    echo Error: "$i" not a PDF file. Ignoring.
    let "e++"
  fi
done

# concatenating all pdf (with blank pages) into one file
fullfile=/tmp/fullfile.pdf
pdftk $pdffiles cat output $fullfile

# printing fullfile
# job="lpr $printer -o sides=two-sided-long-edge -o page-ranges=47-59"
job="lpr $printer -o sides=two-sided-long-edge"
cat $fullfile | ssh baiseraa@ipvslogin.informatik.uni-stuttgart.de $job
echo Sent.

if [[ $e > 0 ]]
then
  echo Files not printed: $e
fi

return $e

